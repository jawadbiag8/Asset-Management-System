<div>
  <!-- Filter Bar -->
  <div class="mb-3">
    <div
      class="d-flex justify-content-between align-items-center flex-wrap gap-2"
      style="width: 100%"
    >
      @if (filters.length > 0) {
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <button
            type="button"
            class="filter-add-btn"
            (click)="openFilterDialog()"
            title="Add filter"
          >
            <mat-icon>add</mat-icon>
            Add Filters
          </button>
          @for (filter of filters; track filter.id) {
            @if (
              filter.value && filter.value !== "" && filter.value !== "All"
            ) {
              <span
                class="filter-pill filter-pill-selected"
                (click)="filter.removable && onFilterRemove(filter.id)"
              >
                {{ filter.label }}
                @if (filter.removable) {
                  <mat-icon class="filter-close-icon">close</mat-icon>
                }
              </span>
            }
          }
        </div>
      }

      <!-- Optional header actions (e.g. Import Assets) + Search Bar -->
      <div class="d-flex align-items-center gap-2">
        <ng-content select="[headerActions]"></ng-content>
        @if (config.searchPlaceholder) {
          <div class="search-container">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="search"
              inputmode="search"
              class="search-input"
              [placeholder]="config.searchPlaceholder"
              [(ngModel)]="searchValue"
              (change)="onSearchButtonClick()"
              (keyup.enter)="onSearchButtonClick()"
            />
            <button
              class="search-button search-button-mobile"
              (click)="onSearchButtonClick()"
              type="button"
              title="Search"
            >
              <mat-icon>search</mat-icon>
            </button>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Table + Scrollable Area -->
  <div class="table-wrapper">
    <div class="table-clip">
    @if (sortedData.length === 0) {
      <div class="empty-state">
        <p class="empty-state-text">
          {{ config.emptyStateMessage || "No data available" }}
        </p>
      </div>
    } @else {
      <div class="table-container">
        <table
          mat-table
          [dataSource]="sortedData"
          class="assets-table"
          [style.min-width]="config.minWidth || '1400px'"
        >
          @for (column of config.columns; track column.key) {
            <ng-container [matColumnDef]="column.key">
              <th
                mat-header-cell
                *matHeaderCellDef
                [style.width]="column.width"
                [attr.data-column]="column.key"
                [attr.data-cell-type]="column.cellType"
              >
                @if (column.sortable !== false) {
                  <div class="sortable-header" (click)="onSort(column.key)">
                    <span class="header-text">{{ column.header }}</span>
                    <mat-icon
                      class="sort-icon"
                      [ngClass]="getSortIconClass(column.key)"
                    >
                      {{ getSortIcon(column.key) }}
                    </mat-icon>
                  </div>
                } @else {
                  {{ column.header }}
                }
              </th>
              <td
                mat-cell
                *matCellDef="let row"
                [style.width]="column.width"
                [attr.data-column]="column.key"
                [matTooltip]="
                  hasTooltip(column) ? getTooltipText(row, column) : ''
                "
                [matTooltipPosition]="column.tooltipPosition || 'above'"
                [matTooltipDisabled]="!hasTooltip(column) || !getTooltipText(row, column) || (column.cellType === 'badge-with-subtext' && column.subtextAsTooltip)"
              >
                @switch (column.cellType) {
                  @case ("icon") {
                    <div
                      class="analyze-icon-container"
                      [style.background-color]="column.iconBgColor"
                      [class.clickable]="column.onClick"
                      [class.pointer]="column.onClick"
                      (click)="
                        column.onClick
                          ? column.onClick(row)
                          : onIconClick(row, column.key)
                      "
                    >
                      @if (column.iconUrl) {
                        <img
                          [src]="column.iconUrl"
                          alt="icon"
                          class="custom-icon"
                        />
                      } @else {
                        <mat-icon
                          class="analyze-icon"
                          [style.color]="column.iconColor"
                        >
                          {{ column.iconName }}
                        </mat-icon>
                      }
                    </div>
                  }
                  @case ("two-line") {
                    <div
                      class="two-line-cell"
                      [class.two-line-cell-with-trailing]="column.trailingButtonLabel && column.trailingButtonClick"
                      [class.clickable]="column.onClick || column.routerLinkFn"
                      [class.pointer]="column.onClick || column.routerLinkFn"
                      (click)="column.onClick && !column.routerLinkFn ? column.onClick(row) : null"
                    >
                      <div class="two-line-cell-text" [class.flex-1]="column.trailingButtonLabel && column.trailingButtonClick">
                        @if (column.routerLinkFn && (column.routerLinkFn(row).commands.length)) {
                          <a
                            [routerLink]="column.routerLinkFn(row).commands"
                            [queryParams]="column.routerLinkFn(row).queryParams || null"
                            class="line-primary line-link"
                            [ngClass]="getTwoLinePrimaryClasses(column, row)"
                            (click)="$event.stopPropagation()"
                          >
                            {{ getCellValue(row, column.primaryField || "") }}
                          </a>
                        } @else {
                          <div
                            class="line-primary"
                            [ngClass]="getTwoLinePrimaryClasses(column, row)"
                          >
                            {{ getCellValue(row, column.primaryField || "") }}
                          </div>
                        }
                        @if (column.linkField) {
                          <a
                            [href]="getCellValue(row, column.linkField || '')"
                            target="_blank"
                            class="line-primary line-link line-secondary-link"
                            [ngClass]="getTwoLineLinkSecondaryClasses(column, row)"
                            (click)="$event.stopPropagation()"
                          >
                            {{ getCellValue(row, column.secondaryField || "") }}
                          </a>
                        } @else {
                          <div
                            class="line-secondary"
                            [ngClass]="getTwoLineSecondaryClasses(column, row)"
                          >
                            {{ getCellValue(row, column.secondaryField || "") }}
                          </div>
                        }
                      </div>
                      @if (column.trailingButtonLabel && column.trailingButtonClick) {
                        <button
                          type="button"
                          class="trailing-btn-outline"
                          (click)="$event.stopPropagation(); column.trailingButtonClick(row)"
                        >
                          {{ column.trailingButtonLabel }}
                        </button>
                      }
                    </div>
                  }
                  @case ("link") {
                    <div class="two-line-cell">
                      @if (getCellValue(row, column.linkField || "")) {
                        <a
                          [href]="getCellValue(row, column.linkField || '')"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="link-text"
                        >
                          {{ getCellValue(row, column.primaryField || "") }}
                        </a>
                        @if (column.secondaryField) {
                          <div class="line-secondary">
                            {{ getCellValue(row, column.secondaryField || "") }}
                          </div>
                        }
                      } @else {
                        <div class="line-primary">
                          {{ getCellValue(row, column.primaryField || "") }}
                        </div>
                        @if (column.secondaryField) {
                          <div class="line-secondary">
                            {{ getCellValue(row, column.secondaryField || "") }}
                          </div>
                        }
                      }
                    </div>
                  }
                  @case ("badge") {
                    <div class="badge-wrapper">
                      <span
                        class="badge"
                        [ngClass]="column.badgeStatus ? getBadgeStatusClass(row, column) : getBadgeClass(getBadgeColor(row, column))"
                        [style.background-color]="!column.badgeStatus ? getBadgeColor(row, column) : null"
                        [style.color]="!column.badgeStatus ? getBadgeTextColor(row, column) : null"
                      >
                        {{ getCellValue(row, column.badgeField || "") }}
                      </span>
                    </div>
                  }
                  @case ("badge-with-subtext") {
                    <div class="badge-cell">
                      <span
                        class="badge"
                        [ngClass]="column.badgeStatus ? getBadgeStatusClass(row, column) : getBadgeClass(getBadgeColor(row, column))"
                        [style.background-color]="!column.badgeStatus ? getBadgeColor(row, column) : null"
                        [style.color]="!column.badgeStatus ? getBadgeTextColor(row, column) : null"
                        [matTooltip]="column.subtextAsTooltip && hasTooltip(column) ? getTooltipText(row, column) : ''"
                        [matTooltipPosition]="column.tooltipPosition || 'above'"
                        [matTooltipDisabled]="!column.subtextAsTooltip || !hasTooltip(column) || !getTooltipText(row, column)"
                      >
                        {{ getCellValue(row, column.badgeField || "") }}
                      </span>
                      @if (!column.subtextAsTooltip) {
                        <div class="line-secondary mt-1">
                          {{ getCellValue(row, column.subtextField || "") }}
                        </div>
                      }
                    </div>
                  }
                  @case ("text-with-color") {
                    <div class="two-line-cell">
                      <div
                        class="line-primary"
                        [ngClass]="getTextColorClass(row, column)"
                      >
                        {{ getCellValue(row, column.primaryField || "") }}
                      </div>
                      <div
                        class="line-secondary"
                        [ngClass]="getSecondaryTextColorClass(row, column)"
                      >
                        {{ getCellValue(row, column.secondaryField || "") }}
                      </div>
                    </div>
                  }
                  @case ("metric-with-trend") {
                    <div class="metric-with-trend-cell">
                      <div
                        class="metric-trend-line"
                        [ngClass]="getTextColorClass(row, column)"
                      >
                        <span class="metric-trend-text">{{
                          getCellValue(row, column.primaryField || "")
                        }}</span>
                        <mat-icon class="metric-trend-icon">{{
                          getTrendIconName(row, column)
                        }}</mat-icon>
                      </div>
                      <div class="metric-trend-percentage">
                        {{ getCellValue(row, column.secondaryField || "") }}
                      </div>
                    </div>
                  }
                  @case ("health-status") {
                    <div
                      class="health-status-cell"
                      [ngClass]="
                        getHealthIconClass(
                          getCellValue(row, column.healthIconField || '')
                        )
                      "
                    >
                      <div class="health-status-line">
                        <span class="health-status-text">{{
                          getCellValue(row, column.healthStatusField || "")
                        }}</span>
                        <svg class="health-bar-icon" width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <path
                            d="M10.5 2V14H13.5V2H10.5ZM6.5 5.5V14H9.5V5.5H6.5ZM2.5 9V14H5.5V9H2.5Z"
                            [attr.fill]="getHealthIconFillColor(getCellValue(row, column.healthIconField || ''))"
                          />
                        </svg>
                      </div>
                      <div class="health-percentage">
                        {{
                          getCellValue(row, column.healthPercentageField || "")
                        }}
                      </div>
                    </div>
                  }
                  @case ("actions") {
                    <div class="actions-cell" [ngClass]="column.cellClass">
                      @if (
                        column.actionLinks && column.actionLinks.length > 0
                      ) {
                        @for (action of column.actionLinks; track $index) {
                          <button
                            type="button"
                            class="action-link me-2"
                            [class.action-link-icon]="action.display === 'icon'"
                            [style.color]="action.color"
                            [disabled]="getActionDisabled(row, action)"
                            [attr.aria-label]="action.label"
                            [matTooltip]="action.label"
                            matTooltipPosition="above"
                            (click)="
                              $event.stopPropagation();
                              onIconClick(row, action.label)
                            "
                          >
                            @if (action.display === "icon" && action.iconName) {
                              <mat-icon [attr.aria-hidden]="true">{{
                                action.iconName
                              }}</mat-icon>
                            } @else {
                              {{ action.label }}
                            }
                          </button>
                          @if (!$last) {
                            <span class="text-muted">|</span>
                          }
                        }
                      }
                    </div>
                  }
                  @case ("progress-bar") {
                    <div class="progress-bar-cell">
                      <div
                        class="progress-bar-container"
                        [style.background-color]="
                          getProgressBgColor(row, column)
                        "
                      >
                        <div
                          class="progress-bar-fill"
                          [style.width.%]="getProgressValue(row, column)"
                          [style.background-color]="
                            getProgressColor(row, column)
                          "
                        ></div>
                      </div>
                      @if (column.progressShowLabel !== false) {
                        <span class="progress-bar-label">
                          {{ getProgressValue(row, column) }}%
                        </span>
                      }
                    </div>
                  }
                  @default {
                    <div
                      class="text-cell-with-icon"
                      [class.has-icon]="
                        column.showIcon && (column.iconName || column.iconUrl)
                      "
                      [class.clickable]="column.onClick"
                      [class.pointer]="column.onClick"
                      (click)="onTextCellClick($event, column, row)"
                    >
                      <span [ngClass]="column.cellClass">
                        {{
                          getCellValue(row, column.primaryField || column.key)
                        }}
                        @if (column.showIcon && column.iconUrl) {
                          <img
                            [src]="column.iconUrl"
                            alt=""
                            class="text-cell-icon text-cell-icon-img"
                            aria-hidden="true"
                          />
                        }
                        @if (
                          column.showIcon && column.iconName && !column.iconUrl
                        ) {
                          <mat-icon class="text-cell-icon" aria-hidden="true">{{
                            column.iconName
                          }}</mat-icon>
                        }
                      </span>
                    </div>
                  }
                }
              </td>
            </ng-container>
          }

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>

      <!-- Pagination (sticky inside wrapper) -->
      @if (sortedData.length > 0) {
        <div class="pagination-container">
          <div class="pagination-info">
            <span class="row-count-text"
              >{{ getDisplayedRange() }} of {{ effectiveTotalItems }}</span
            >
          </div>

          <div class="pagination-right-section">
            <div class="pagination-rows-per-page">
              <span class="rows-per-page-label">Rows per page:</span>
              <select
                class="rows-per-page-select"
                [value]="pageSize"
                (change)="onPageSizeChange($event)"
              >
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>

            <div class="pagination-navigation">
              <button
                class="pagination-button"
                [disabled]="currentPage === 1"
                (click)="onPreviousPage()"
                type="button"
              >
                <mat-icon>chevron_left</mat-icon>
              </button>
              <span class="page-indicator">
                <span class="current-page">{{ currentPage }}</span
                >/<span class="total-pages">{{ totalPages }}</span>
              </span>
              <button
                class="pagination-button"
                [disabled]="currentPage === totalPages"
                (click)="onNextPage()"
                type="button"
              >
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>
        </div>
      }
    }
    </div>
  </div>
</div>
