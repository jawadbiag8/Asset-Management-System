<div class="incident-detail-page">
  <app-reusable-breadcrum [breadcrumbs]="[
      { label: 'Dashboard', path: '/pm-dashboard' },
      { label: 'Incidents', path: '/incidents' },
      { label: incident()?.ministryName || 'Incident Details' }
    ]"></app-reusable-breadcrum>

  @if (loading()) {
  <div class="loading-state">
    <p>Loading incident details...</p>
  </div>
  } @else if (errorMessage()) {
  <div class="error-state">
    <p>{{ errorMessage() }}</p>
    <button class="btn btn-back" (click)="onBack()">Back to Incidents</button>
  </div>
  } @else if (incident()) {
  <div class="incident-details-layout">
    <!-- Left Column: Service Outage + Incident Reason -->
    <div class="left-column">
      <!-- Card 1: Service Outage Details -->
      <div class="card card-service-outage">
        <div class="card-header">
          <h2 class="card-title">Service Outage</h2>
          <span class="severity-badge" [style.background-color]="getSeverityBadgeColor(incident()?.severity || '')"
            [style.color]="getSeverityBadgeTextColor(incident()?.severity || '')"
            [style.border-color]="getSeverityBorderColor(incident()?.severity || '')">
            {{ getSeverityLabel(incident()?.severity || '') ? (formatSeverityCode(incident()?.severity || '') + ' - ' +
            getSeverityLabel(incident()?.severity || '')) : (incident()?.severity || 'N/A') }}
          </span>
        </div>
        <div class="info-two-cols">
          <div class="info-col">
            <div class="info-item">
              <span class="info-label">STATUS</span>
              <span class="status-badge" [style.background-color]="getStatusBadgeColor(incident()?.status || '')"
                [style.color]="getStatusBadgeTextColor(incident()?.status || '')">
                {{ (incident()?.status || 'N/A') | uppercase }}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">ASSIGNED TO</span>
              <span class="info-value">{{ incident()?.updatedBy ?? '—' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">ASSET</span>
              <span class="info-value">
                @if (incident()?.assetUrl) {
                <a [href]="incident()!.assetUrl" target="_blank" rel="noopener noreferrer" class="asset-link">
                  {{ incident()?.assetName ?? '—' }}
                </a>
                } @else {
                {{ incident()?.assetName ?? '—' }}
                }
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">MINISTRY</span>
              <span class="info-value">{{ incident()?.ministryName ?? '—' }}</span>
            </div>
          </div>
          <div class="info-col">
            <div class="info-item">
              <span class="info-label">CREATED ON</span>
              <span class="info-value">{{ formatDateShort(incident()?.createdAt) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">KPI</span>
              <span class="info-value">{{ incident()?.kpiDescription ?? '—' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">CREATED BY</span>
              <span class="info-value">{{ incident()?.createdBy ?? '—' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">DEPARTMENT</span>
              <span class="info-value">{{ getDepartmentName() || '—' }}</span>
            </div>
          </div>
        </div>
        <div class="description-block">
          <span class="description-label">DESCRIPTION</span>
          <p class="description-text">{{ incident()?.description || 'No description available' }}</p>
        </div>

        <!-- Card 2: Incident Reason KPIs -->
        @if (showIncidentReasonSection()) {
        <br>
        <div class="description-block">

          <h2 class="card-title-small">INCIDENT REASON</h2>
          <div class="card card-incident-reason">
            <div class="kpi-list">
              @for (metric of incidentReasonMetrics(); track $index) {
              <div class="kpi-item">
                <div class="kpi-name">KPI: {{ metric.name }}</div>
                <div class="kpi-row">
                  <span class="kpi-value-label">Value:</span>
                  <span class="kpi-value">{{ metric.value }}</span>
                </div>
                @if (metric.target != null && metric.target !== '' && metric.target !== '—') {
                <div class="kpi-row">
                  <span class="kpi-value-label">Target:</span>
                  <span class="kpi-value">{{ metric.target }}</span>
                </div>
                }
                <div class="kpi-checked">Checked at: {{ metric.timestamp }}</div>
              </div>
              } @empty {
              <div class="kpi-empty">No incident reason metrics available</div>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Right Column: Timeline + Comments -->
    <div class="right-column">
      <!-- Timeline Card -->
      <div class="card card-timeline">
        <h2 class="card-title-small">Timeline</h2>
        <div class="timeline-list">
          @for (event of timelineEvents(); track event.id) {
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-body">
              <span class="timeline-time">{{ event.time }}</span>
              <p class="timeline-text">{{ event.description }}</p>
              <span class="timeline-status-badge" [style.background-color]="getStatusBadgeColor(event.status)"
                [style.color]="getStatusBadgeTextColor(event.status)">
                {{ event.status | uppercase }}
              </span>
            </div>
          </div>
          } @empty {
          <div class="timeline-empty">No timeline events available</div>
          }
        </div>
      </div>

      <!-- Comments Card -->
      <div class="card card-comments">
        <h2 class="card-title-small">Comments</h2>
        <div class="comments-form">
          <mat-form-field appearance="outline" class="comment-textarea-field">
            <mat-label>Write your Comments</mat-label>
            <textarea matInput [(ngModel)]="commentText" rows="5" maxlength="500" placeholder="Write your Comments">
              </textarea>
          </mat-form-field>
          <span class="comment-char-count">{{ commentText.length }} / 500</span>
          <!-- <mat-form-field appearance="outline" class="status-select-field">
              <mat-label>Change Status</mat-label>
              <mat-select [(ngModel)]="selectedStatus" panelClass="incident-status-select-panel">
                <mat-option value="">Change Status</mat-option>
                <mat-option value="OPEN">OPEN</mat-option>
                <mat-option value="INVESTIGATING">INVESTIGATING</mat-option>
                <mat-option value="FIXING">FIXING</mat-option>
                <mat-option value="MONITORING">MONITORING</mat-option>
                <mat-option value="RESOLVED">RESOLVED</mat-option>
              </mat-select>
            </mat-form-field> -->
          <button mat-raised-button color="primary" class="submit-btn" [disabled]="submittingComment()"
            (click)="onSubmitComment()">
            {{ submittingComment() ? 'Submitting...' : 'Submit' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
